# ===============================
# ACA PROJECT - COMPLETE COMMAND WORKFLOW
# ===============================

# ---------------------------------
# PHASE 1: SETUP AND BUILD SIMPLESIM
# ---------------------------------

# Create ACA project root directory
mkdir ACA
cd ACA

# Create subdirectory for SimpleScalar
mkdir simplescalar
cd simplescalar

# Clone the SimpleScalar 3.0 source code
git clone https://github.com/toddmaustin/simplesim-3.0.git

# Enter the cloned directory
cd ~/ACA/simplescalar/simplesim-3.0

# Configure SimpleScalar for the PISA target
make config-pisa

# Build all components
make

# ---------------------------------
# PHASE 1 TEST RUNS (SANITY CHECK)
# ---------------------------------

# Run functional simulator (simple correctness check)
./sim-safe tests/bin.little/test-math

# Run out-of-order simulator and save output report
./sim-outorder tests/bin.little/test-math > ~/ACA/simplescalar/baseline_report.txt


# ---------------------------------
# PHASE 2: CACHE PREFETCHING EXPERIMENTS
# ---------------------------------

# Create directory to store cache prefetch experiment results
mkdir -p ~/ACA/phase2_cache_prefetch/results

# Clean and rebuild the project with all cores
make clean
make -j$(nproc)


# ---------- BASELINE RUN (No Prefetching) ----------
unset PREFETCH_MODE
/home/aravind/ACA/simplescalar/simplesim-3.0/sim-outorder \
  -max:inst 5000000 \
  -redir:sim /home/aravind/ACA/phase2_cache_prefetch/results/baseline_test-math.txt \
  /home/aravind/ACA/simplescalar/simplesim-3.0/tests/bin.little/test-math


# ---------- NEXT-LINE PREFETCH ----------
export PREFETCH_MODE=nextline
/home/aravind/ACA/simplescalar/simplesim-3.0/sim-outorder \
  -max:inst 5000000 \
  -redir:sim /home/aravind/ACA/phase2_cache_prefetch/results/nextline_test-math.txt \
  /home/aravind/ACA/simplescalar/simplesim-3.0/tests/bin.little/test-math


# ---------- ONE-BLOCK LOOKAHEAD PREFETCH ----------
export PREFETCH_MODE=oneblock
/home/aravind/ACA/simplescalar/simplesim-3.0/sim-outorder \
  -max:inst 5000000 \
  -redir:sim /home/aravind/ACA/phase2_cache_prefetch/results/oneblock_test-math.txt \
  /home/aravind/ACA/simplescalar/simplesim-3.0/tests/bin.little/test-math


# ---------- STRIDE PREFETCH ----------
export PREFETCH_MODE=stride
/home/aravind/ACA/simplescalar/simplesim-3.0/sim-outorder \
  -max:inst 5000000 \
  -redir:sim /home/aravind/ACA/phase2_cache_prefetch/results/stride_test-math.txt \
  /home/aravind/ACA/simplescalar/simplesim-3.0/tests/bin.little/test-math


# ---------------------------------
# PHASE 3: MEMORY LATENCY EXPERIMENTS
# ---------------------------------

# Create a directory for Phase-3 results
mkdir -p ~/ACA/phase3_mem_latency/results

# Navigate to the Phase-3 working folder
cd ~/ACA/phase3_mem_latency

# Compile the memory latency test program
gcc -O2 -pthread memlat.c -o memlat


# ---------- RUN MEMORY LATENCY TESTS ----------

# 1. Baseline backward pointer scan
./memlat > results/baseline_latency.txt

# 2. Forward pointer scan
./memlat --forward > results/forward_latency.txt

# 3. Concurrent pointer traversal
./memlat --concurrent > results/concurrent_latency.txt

# 4. Index-based access test
./memlat --index > results/index_latency.txt

# 5. Index access with stride 64
./memlat --index --stride 64 --max-size 256 > results/index_stride64.txt

# 6. Index access with stride 256
./memlat --index --stride 256 --max-size 256 > results/index_stride256.txt

# 7. Index access with stride 1024
./memlat --index --stride 1024 --max-size 256 > results/index_stride1024.txt


# ---------------------------------
# VERIFY GENERATED RESULTS
# ---------------------------------

# List all generated results with file sizes
ls -lh results/

# Display first 15 lines of baseline latency output
head -n 15 results/baseline_latency.txt


# ---------------------------------
# SUMMARY OF DIRECTORIES
# ---------------------------------
# SimpleScalar Source:     ~/ACA/simplescalar/simplesim-3.0
# Prefetch Results:        ~/ACA/phase2_cache_prefetch/results
# Memory Latency Results:  ~/ACA/phase3_mem_latency/results
# ---------------------------------

# ============================================================
#                    PHASE 4: CPU PERFORMANCE & POWER MODELLING
# ============================================================

# -----------------------------------------------
# Step 1 : Setup Phase-4 Folder
# -----------------------------------------------
mkdir -p /home/aravind/ACA/phase4_cpu_perf
mkdir -p /home/aravind/ACA/phase4_cpu_perf/results
cd /home/aravind/ACA/phase4_cpu_perf

# -----------------------------------------------
# Step 2 : Verify and Build SimpleScalar Simulator
# -----------------------------------------------
cd /home/aravind/ACA/simplescalar/simplesim-3.0
make clean || true
make -j$(nproc)

# Verify sim-outorder binary
ls -l /home/aravind/ACA/simplescalar/simplesim-3.0/sim-outorder

# -----------------------------------------------
# Step 3 : Memory Latency Extraction (From Phase-3)
# -----------------------------------------------
cd /home/aravind/ACA/phase3_mem_latency
gcc -O2 -pthread memlat.c -o memlat
./memlat > /home/aravind/ACA/phase4_cpu_perf/results/memlat_output.txt

# Preview latency data
head -n 30 /home/aravind/ACA/phase4_cpu_perf/results/memlat_output.txt

# -----------------------------------------------
# Step 4 : Parse Latency Levels (L1/L2/L3/DRAM)
# -----------------------------------------------
echo "Using simulated CPU frequency of 2.5 GHz"
FREQ_GHZ=2.5

# Extract unique latency values
awk -F',' '/^[0-9]/{print $3}' /home/aravind/ACA/phase4_cpu_perf/results/memlat_output.txt | sort -n | uniq > /home/aravind/ACA/phase4_cpu_perf/results/latencies_only.txt

# Count number of latency samples
wc -l /home/aravind/ACA/phase4_cpu_perf/results/latencies_only.txt

# Extract approximate latency percentiles (5%, 30%, 60%, 95%)
L1_ns=$(sed -n "$((39*5/100+1))p"  /home/aravind/ACA/phase4_cpu_perf/results/latencies_only.txt)
L2_ns=$(sed -n "$((39*30/100+1))p" /home/aravind/ACA/phase4_cpu_perf/results/latencies_only.txt)
L3_ns=$(sed -n "$((39*60/100+1))p" /home/aravind/ACA/phase4_cpu_perf/results/latencies_only.txt)
DRAM_ns=$(sed -n "$((39*95/100+1))p" /home/aravind/ACA/phase4_cpu_perf/results/latencies_only.txt)

# Print Latency Results (in ns)
echo "Approximate latencies in nanoseconds:"
echo "  L1   = ${L1_ns} ns"
echo "  L2   = ${L2_ns} ns"
echo "  L3   = ${L3_ns} ns"
echo "  DRAM = ${DRAM_ns} ns"

# Convert to cycles (2.5 GHz)
L1_cyc=$(awk 'BEGIN { printf("%d", 1.144 * 2.5 + 0.5) }')
L2_cyc=$(awk 'BEGIN { printf("%d", 1.337 * 2.5 + 0.5) }')
L3_cyc=$(awk 'BEGIN { printf("%d", 2.724 * 2.5 + 0.5) }')
DRAM_cyc=$(awk 'BEGIN { printf("%d", 9.049 * 2.5 + 0.5) }')

# Display final table
echo ""
echo "======  Phase-4 Latency Calibration Results  ======"
echo "CPU Frequency : 2.50 GHz"
echo "----------------------------------------------------"
printf " %-6s | %-15s | %-15s\n" "Level" "Latency (ns)" "Latency (cycles)"
echo "----------------------------------------------------"
printf " %-6s | %-15.3f | %-15d\n" "L1"   "$L1_ns"   "$L1_cyc"
printf " %-6s | %-15.3f | %-15d\n" "L2"   "$L2_ns"   "$L2_cyc"
printf " %-6s | %-15.3f | %-15d\n" "L3"   "$L3_ns"   "$L3_cyc"
printf " %-6s | %-15.3f | %-15d\n" "DRAM" "$DRAM_ns" "$DRAM_cyc"
echo "----------------------------------------------------"

# -----------------------------------------------
# Step 5 : CPU Micro-Benchmark Tests
# -----------------------------------------------
mkdir -p /home/aravind/ACA/phase4_cpu_perf/tests
cd /home/aravind/ACA/phase4_cpu_perf/tests

# Create & Compile Test Programs
gcc -O2 int_arith.c   -o /home/aravind/ACA/phase4_cpu_perf/tests/int_arith
gcc -O2 float_arith.c -lm -o /home/aravind/ACA/phase4_cpu_perf/tests/float_arith
gcc -O2 mem_copy.c    -o /home/aravind/ACA/phase4_cpu_perf/tests/mem_copy
gcc -O2 mix_load.c    -lm -o /home/aravind/ACA/phase4_cpu_perf/tests/mix_load

# Run All Tests
/home/aravind/ACA/phase4_cpu_perf/tests/int_arith
/home/aravind/ACA/phase4_cpu_perf/tests/float_arith
/home/aravind/ACA/phase4_cpu_perf/tests/mem_copy
/home/aravind/ACA/phase4_cpu_perf/tests/mix_load

# -----------------------------------------------
# Step 6 : Power / Energy Modelling (Route A)
# -----------------------------------------------
mkdir -p /home/aravind/ACA/phase4_cpu_perf/power_model
mkdir -p /home/aravind/ACA/phase4_cpu_perf/power_model/results
cd /home/aravind/ACA/phase4_cpu_perf/power_model

# Copy latency file for reference
cp /home/aravind/ACA/phase4_cpu_perf/results/latencies_only.txt ./latencies_only.txt

# Run Power Model Script
python3 /home/aravind/ACA/phase4_cpu_perf/power_model/power_model.py

# Preview Power Summary
cat /home/aravind/ACA/phase4_cpu_perf/power_model/results/power_summary.csv

# ============================================================
# END OF PHASE 4
# ============================================================

# ============================================================
#  PHASE 5 : CPU PERFORMANCE DASHBOARD (Route B)
#  Directory : /home/aravind/ACA/phase5_dashboard
#  Description : Dashboard for visualization of Phase 4 performance
#                and power model data using Flask + Dash + Plotly.
# ============================================================

# ------------------------------------------------------------
# Step 1 : Create directory structure
# ------------------------------------------------------------
mkdir -p /home/aravind/ACA/phase5_dashboard/scripts
mkdir -p /home/aravind/ACA/phase5_dashboard/data
mkdir -p /home/aravind/ACA/phase5_dashboard/static
mkdir -p /home/aravind/ACA/phase5_dashboard/templates
mkdir -p /home/aravind/ACA/phase5_dashboard/logs

# ------------------------------------------------------------
# Step 2 : Setup Python virtual environment
# ------------------------------------------------------------
sudo apt update && sudo apt install -y python3.12-venv

# create venv (delete old one if exists)
rm -rf /home/aravind/ACA/phase5_dashboard/venv
python3 -m venv /home/aravind/ACA/phase5_dashboard/venv

# activate the environment
source /home/aravind/ACA/phase5_dashboard/venv/bin/activate

# verify versions
python -V
pip -V

# ------------------------------------------------------------
# Step 3 : Upgrade pip and install dependencies
# ------------------------------------------------------------
pip install --upgrade pip setuptools wheel

# Core libraries for dashboard + data processing
pip install pandas flask matplotlib plotly dash flask-cors

# optional (if you plan to read CSVs or NumPy arrays)
pip install numpy

# confirm installations
pip list

# ------------------------------------------------------------
# Step 4 : Place or create data collection script
# ------------------------------------------------------------
# Your Phase 4 data collection script should be located at:
#   /home/aravind/ACA/phase5_dashboard/scripts/collect_phase4_data.py
# Make sure it outputs results to the "data" folder.

chmod +x /home/aravind/ACA/phase5_dashboard/scripts/collect_phase4_data.py
python /home/aravind/ACA/phase5_dashboard/scripts/collect_phase4_data.py

# Inspect the generated output data
ls -lh /home/aravind/ACA/phase5_dashboard/data
head /home/aravind/ACA/phase5_dashboard/data/memlat.csv
cat /home/aravind/ACA/phase5_dashboard/data/summary_report.txt

# ------------------------------------------------------------
# Step 5 : Run the Dashboard Application
# ------------------------------------------------------------
chmod +x /home/aravind/ACA/phase5_dashboard/scripts/dashboard_app.py
python /home/aravind/ACA/phase5_dashboard/scripts/dashboard_app.py

# ------------------------------------------------------------
# Step 6 : (Optional) Create start script for convenience
# ------------------------------------------------------------
cat << 'EOF' > /home/aravind/ACA/phase5_dashboard/start_dashboard.sh
#!/bin/bash
cd /home/aravind/ACA/phase5_dashboard
source venv/bin/activate
python scripts/dashboard_app.py
deactivate
EOF

chmod +x /home/aravind/ACA/phase5_dashboard/start_dashboard.sh

# To start dashboard anytime:
# ./start_dashboard.sh

# ------------------------------------------------------------
# Step 7 : Logs and output monitoring
# ------------------------------------------------------------
# (optional for debugging)
# tail -f /home/aravind/ACA/phase5_dashboard/logs/dashboard.log

# ------------------------------------------------------------
# Step 8 : Deactivate venv after work
# ------------------------------------------------------------
deactivate

# To reactivate later:
# cd /home/aravind/ACA/phase5_dashboard
# source venv/bin/activate
# python scripts/dashboard_app.py
# deactivate
# ============================================================
